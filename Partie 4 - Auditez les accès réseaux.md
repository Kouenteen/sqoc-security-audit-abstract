# 0. Informations diverses

Voyons d√©sormais l'audit des acc√®s r√©seau ouverts sur le serveur, ainsi que les programmes et services qui ouvrent les ports associ√©s.

# 1. Les ports ouverts du serveur et les processus associ√©s

## 1.1 Introduction

> Les acc√®s r√©seau sont la cible de la plupart des attaques √† distance. Chaque service accessible √† distance ouvre un ou plusieurs ports de connexion sur le serveur, et donc un acc√®s via le r√©seau.

En fonction de ce qui est ouvert et des flux de requ√™te qui leurs sont destin√©s, les acc√®s r√©seaux doivent √™tre particuli√®rement surveill√©s et ma√Ætris√©s.

Par exemple, ils sont critiques sur un serveur Web accessible au public. Ils sont probablement moins critiques, mais restent sensibles sur une base de donn√©es prot√©g√©e dans le bastion de l'architecture r√©seau interne d'une entreprise.

Pour lister les ports ouverts sur le serveur, Linux propose plusieurs outils.

Parmi ces outils, on retrouve la traditionnelle commande `netstat`, qui n'est plus install√©e par d√©faut mais est accessible via le paquet `net-tools`.

> Cette commande est d√©sormais remplac√©e par la commande `ss` qui reprend toutes les options de netstat.

Lan√ßons la commande `ss -plunt` :

    [root@machine ~]# ss -lptun
    Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port
    udp UNCONN 0 0 127.0.0.1:323 *:* users:(("chronyd",pid=573,fd=1))
    udp UNCONN 0 0 *:68 *:* users:(("dhclient",pid=2467,fd=6))
    udp UNCONN 0 0 ::1:323 :::* users:(("chronyd",pid=573,fd=2))
    tcp LISTEN 0 0 *:3306 *:* users:(("mysqld",pid=1209,fd=13))
    tcp LISTEN 0 0 *:22 *:* users:(("sshd",pid=818,fd=3))
    tcp LISTEN 0 0 127.0.0.1:25 *:* users:(("master",pid=1253,fd=13))
    tcp LISTEN 0 0 :::80 :::* users:(("httpd",pid=2004,fd=4),("httpd",pid=2003,fd=4),("httpd",pid=2002,fd=4),("httpd",pid=2001,fd=4),("httpd",pid=2000,fd=4),("httpd",pid=817,fd=4))
    tcp LISTEN 0 0 :::21 :::* users:(("proftpd",pid=860,fd=0))
    tcp LISTEN 0 0 :::22 :::* users:(("sshd",pid=818,fd=4))
    tcp LISTEN 0 0 ::1:25 :::* users:(("master",pid=1253,fd=14))

Les options pass√©es √† cette commande correspondent aux fonctionnalit√©s suivantes :

| Option      | Description |
| ----------- | ----------- |
| p   | Affiche le processus utilisant la socket |
| l   | Affiche toutes les sockets en √©coute |
| u   | Affiche les sockets de protocole UDP |
| n   | Affiche les ports ouverts en mode num√©rique |
| t   | Affiche les sockets de protocole TCP |

On peut remarquer que cette commande nous indique l'adresse IP associ√©e au port, par exemple :
- **127.0.0.1** : l'adresse de loopback locale IPv4 (le port est accessible uniquement depuis ce serveur),
- **'*'**: toutes les adresses IPv4 du serveur,
- **::** : toutes les adresses IPv6 du serveur,
- **::1** : l'adresse de loopback locale IPv6 du serveur.

> ‚ùå **RECOMMANDATION-CRITICAL** (Minimisation) : Examinez la liste des _sockets_ et ports ouverts sur le r√©seau.

Par exemple, vous pourriez tout √† fait nettoyer cette liste en fermant les ports suivants :

| Option      | Processus/Service |
| ----------- | ----------- |
| 127.0.0.1:323 et ::1:323   | Chronyd est un serveur de temps qui n'est pas indispensable et est seulement utilis√© quand vous avez besoin d'une horloge commune pour vos applications  |
| *:68   | Pas besoin d'un client DHCP sur une adresse IP publique |
| 127.0.0.1:25 et ::1:25   | Serveur postfix interne est install√© uniquement si vos applications envoient des mails  |

Les ports ouverts par les trois processus cit√©s dans ce tableau d√©pendent de services r√©seau, lanc√©s automatiquement lors du d√©marrage de la machine, ou lanc√©s manuellement.

Lorsque les informations du service ne sont pas affich√©es sur la commande `ss`, il est possible de les retrouver avec la commande `lsof`: 

    [root@machine ~]# lsof -i :323
    COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME
    chronyd 573 chrony 1u IPv4 14211 0t0 UDP localhost:323
    chronyd 573 chrony 2u IPv6 14212 0t0 UDP localhost:323

> ‚ùå **RECOMMANDATION-CRITICAL** (Minimisation) : V√©rifiez que les services qui ouvrent des ports inutiles sont d√©sactiv√©s.

Dans notre cas, pour couper ces services, il faudrait lancer les commandes suivantes :

    systemctl stop chronyd postfix
    systemctl disable chronyd postfix

Le service **dhclient** est directement g√©r√© par le processus de gestion de la carte r√©seau. Il ne d√©marre pas lorsque l'adresse est fix√©e en statique.

Autre remarque importante : concernant le port d'√©coute du service de base de donn√©es, vous pouvez voir la ligne suivante :

    tcp LISTEN 0 0 *:3306 *:* users:(("mysqld",pid=1209,fd=13))

Elle indique que le service est en √©coute sur l'adresse IPv4 du serveur et sur le port 3306. Cette configuration ne convient pas car il est tr√®s peu probable qu'il soit possible d'acc√©der au service de base de donn√©es directement depuis l'environnement externe du serveur.

Nous pouvons m√™me dire qu'une connexion interne en provenance des codes sources de l'application sera largement suffisante.

> ‚ùå **RECOMMANDATION-CRITICAL** (D√©fense en profondeur) : V√©rifiez que les services qui ouvrent des ports sur une interface externe sont pertinents.

Pour v√©rifier cela et ouvrir le port en √©coute uniquement sur la loopback IPv4, modifiez le fichier de configuration du service **/etc/my.cnf** et ajoutez-y la ligne suivante :

    bind-address = 127.0.0.1

Par ailleurs, et dans la mesure du possible, si les services associ√©s ne sont pas publics, il est fortement recommand√© de changer les ports d'acc√®s par d√©faut √† ces services, car ce sont des cibles pour les attaquants.

> üö∏ **RECOMMANDATION-WARNING** (D√©fense en profondeur) : V√©rifiez que les ports par d√©faut des services ont √©t√© chang√©s dans la mesure du possible.

Ici, l'application Web n'est pas publique et nous pourrions tout √† fait envisager de changer le port par d√©faut dans le fichier **/etc/httpd/conf/httpd.conf** en modifiant la ligne concern√©e :

    # Listen: Allows you to bind Apache to specific IP addresses and/or
    # ports, instead of the default. See also the <VirtualHost>
    # directive.
    #
    # Change this to Listen on specific IP addresses as shown below to
    # prevent Apache from glomming onto all bound IP addresses.
    #
    #Listen 12.34.56.78:80
    #Listen 80
    Listen 8282


# 2. Les processus de filtrage r√©seau

> Le filtrage r√©seau consiste √† analyser le trafic entrant et sortant du serveur, et √† √©tablir des r√®gles d√©finissant les actions √† effectuer sur ce trafic. Cette fonctionnalit√© est ex√©cut√©e directement par le noyau Linux.

## 2.1 Les compatibilit√©s avec les TCP Wrappers

Le premier processus de filtrage r√©seau sous Linux est le **TCP Wrapper**. Cette technique s'appuie sur la librairie partag√©e **libwrap** et permet de d√©finir des r√®gles d'acc√®s sur deux fichiers de configuration :
- le fichier **/etc/hosts.allow** qui contient la liste des r√®gles autorisant la connexion √† un service,
- le fichier **/etc/hosts.deny** qui contient la liste des r√®gles refusant la connexion √† un service.

Dans le cas o√π les deux fichiers seraient renseign√©s et pr√©senteraient des incoh√©rences (par exemple, un m√™me service autoris√© dans l'un et refus√© dans l'autre), ce serait le fichier **host.allow** qui pr√©vaudrait. Les r√®gles qu'il contient sont prioritaires.

Le grand avantage de cette technique, c'est qu'il est possible de modifier ces r√®gles sans toucher √† la configuration sp√©cifique des services concern√©s.

Par contre, le service doit √™tre compil√© avec la librairie **libwrap**.

Pour v√©rifier si un service peut √™tre compil√© avec **libwrap**, lancez les commandes suivantes :

    [root@machine ~]# which sshd
    /usr/sbin/sshd
    [root@machine ~]# ldd /usr/sbin/sshd | grep libwrap
    libwrap.so.0 => /lib64/libwrap.so.0 (0x00007fc69c57f000)

    [root@machine ~]# find / -name mysqld
    /usr/libexec/mysqld
    [root@machine ~]# ldd /usr/libexec/mysqld | grep libwrap
    [root@machine ~]#

    [root@machine ~]# which httpd
    /usr/sbin/httpd
    [root@machine ~]# ldd /usr/sbin/httpd | grep libwrap
    [root@machine ~]#

    [root@machine ~]# which proftpd
    /usr/sbin/proftpd
    [root@machine ~]# ldd /usr/sbin/proftpd | grep libwrap
    [root@machine ~]#

Comme nous pouvons le voir, seul le service **sshd** est compatible avec la fonctionnalit√© **TCP Wrapper**.

> ‚ùå **RECOMMANDATION-CRITICAL** (D√©fense en profondeur) : V√©rifiez que les TCP Wrappers sont configur√©s pour les services r√©seau compatibles.

Ici, pour √©tablir les r√®gles de connexion au service **sshd**, il faudrait renseigner les deux lignes suivantes dans les fichiers **/etc/hosts.allow** et **/etc/hosts.deny** :

    # /etc/hosts.allow
    sshd: 1.2.3.0/255.255.255.0 # Masque r√©seau complet
    sshd: 192.168.0.0/255.255.255.0 # Adresse IP sp√©cifique

    # /etc/hosts.deny
    sshd: ALL # Rejet de tout le reste

> üö∏ **RECOMMANDATION-WARNING** (D√©fense en profondeur) : V√©rifiez qu'il est possible de rendre les services r√©seau compatibles avec les TCP Wrappers.

C'est notamment le cas du service **proftpd**, qui devient compatible une fois compil√© avec le module **contrib/mod_wrap.c**.

## 2.2 Les r√®gles du firewall Netfilter

Le second processus de filtrage r√©seau est le firewall **Netfilter**, cod√© directement dans le noyau Linux.

Ce pare-feu fonctionne avec un syst√®me compos√© de trois principaux √©l√©ments :
- les **cha√Ænes**, qui d√©terminent la caract√©ristique principale du paquet r√©seau. La cha√Æne **INPUT** r√®gle le trafic entrant, **OUTPUT** r√®gle le trafic sortant et **FORWARD** le trafic qui transite par le serveur,
- les **r√®gles** qui servent √† reconna√Ætre le type de paquet. Cela peut se faire, entre autres, en fonction de son **adresse source**, de son **port de destination** ou encore de son protocole,
- les **actions**, qui sont associ√©es aux **cha√Ænes** et aux **r√®gles**. Elles d√©terminent ce qu'il se passe : par exemple, **INPUT and DPORT 80 ACCEPT** va laisser entrer tous les paquets √† destination du port 80.

La description est succincte (tr√®s simplifi√©e) car il faudrait faire un cours entier avec beaucoup de pratique sur Netfilter pour y d√©tailler son fonctionnement.

Avant toute chose, on v√©rifie que le code de Netfilter est bien int√©gr√© au noyau :

    [root@machine ~]# grep IPTABLES /boot/config-`uname -r`
    CONFIG_IP_NF_IPTABLES=m
    CONFIG_IP6_NF_IPTABLES=m

La commande ci-dessus indique que le code Netfilter est compil√© comme un module, d'o√π le **m** et qu'il est donc n√©cessaire de le charger pour acc√©der aux fonctionnalit√©s du pare-feu.

Cela ne convient pas au vu de la recommandation que nous avions √©mise sur le noyau (Bloquer le chargement de modules suppl√©mentaires).

> üö∏ **RECOMMANDATION-WARNING** (Minimisation) : V√©rifiez qu'il est possible d'acc√©der au firewall Netfilter par le noyau sans la contraite module.

Linux fournit avec son pare-feu, un jeu de binaires qui permet de manipuler sa configuration, en l'occurence avec la commande **iptables**.

Pour voir la configuration actuelle du pare-feu Netfilter, il faut lancer la commande :

    [root@machine ~]# iptables -L -n
    Chain INPUT (policy ACCEPT)
    target prot opt source destination

    Chain FORWARD (policy ACCEPT)
    target prot opt source destination

    Chain OUTPUT (policy ACCEPT)
    target prot opt source destination

Le r√©sultat de cette commande affiche une configuration par d√©faut typique : une vraie passoire !

Le firewall ne dispose d'aucune r√®gle et est configur√© par d√©faut sur l'action **ACCEPT**. √âvidemment, cette situation ne convient pas.

> ‚ùå **RECOMMANDATION-CRITICAL** (D√©fense en profondeur) : V√©rifiez que les r√®gles Netfilter sont bien positionn√©es.

Il faudrait d√©j√† passer la configuration par d√©faut en **DROP**.

    :INPUT DROP [0:0]
    :FORWARD DROP [0:0]
    :OUTPUT DROP [0:0]

Ensuite, il faut laisser entrer les paquets √† destination des services. Ci-dessous, exemple avec le port par d√©faut du service Web :

    -A INPUT -i eth0 -p tcp -m tcp --dport 80 -j ACCEPT
    -A OUTPUT -o eth0 -p tcp -m tcp --sport 80 -j ACCEPT

Attention : ne pas oublier que la configuration de Netfilter toujours √† chaud et que le noyau ne garde pas cette configuration d'un _reboot_ √† l'autre. Il est donc n√©cessaire de renseigner des fichiers de configuration comme **/etc/sysconfig/iptables** afin de charger des r√®gles par d√©faut √† la fin du processus de d√©marrage.

> ‚ùå **RECOMMANDATION-CRITICAL** (D√©fense en profondeur) : V√©rifiez que les r√®gles Netfilter par d√©faut sont d√©finies dans le fichier de configuration **/etc/sysconfig/iptables**.

## 2.3 Les sysctl du noyau

> Les sysctl du noyau sont des variables accessibles par l'administrateur et permettent d'influer sur le comportement du noyau pour certains aspects de son p√©rim√®tre fonctionnel, comme les pages m√©moires, les syst√®mes de fichiers ou encore le r√©seau.

Il existe de nombreuses **sysctl** pour le r√©seau. Chacune permet de renforcer un peu plus la s√©curit√© r√©seau de la machine. Recensons les plus communes et leur implication :

| SYSCTL      | Description |
| ----------- | ----------- |
| net.ipv4.ip_forward = 0   | Absence de routage sur les interfaces  |
| net.ipv4.conf.all.accept_source_route = 0 net.ipv4.conf.default.accept_source_route = 0   | Refus des paquets de source _routing_  |
| net.ipv4.icmp_echo_ignore_broadcasts = 1   | Configuration contre les temp√™tes ICMP (_Smurf attacks_)  |
| net.ipv4.accept_source_route = 0   | Configuration contre les paquets contenant leur propre routage (utile seulement aux attaquants)  |
| net.ipv4.rp_filter = 1   | Configuration contre les paquets avec une IP incoh√©rente avec l'interface r√©seau de destination (_Spoofing_)  |

Il faut ajouter ces configurations dans le fichier **/etc/sysctl.conf** pour qu'elles soient appliqu√©es √† chaque red√©marrage du serveur.

> ‚ùå **RECOMMANDATION-CRITICAL** (D√©fense en profondeur) : V√©rifiez le positionnement des sysctl r√©seau communes au noyau dans le fichier **/etc/sysctl.conf**.

# 3. Le service SSH

## 3.1 Introduction

Le service SSH est s√ªrement le **service le plus critique sur le serveur**.

C'est le moyen le plus connu et commun pour obtenir un _shell_ distant sur le syst√®me. Cela est possible en se connectant via un terminal sur le service et en chiffrant les communications avec le protocole SSH.

Il est donc tr√®s important de veiller √† ce que ce service soit configur√© de mani√®re s√©curis√©e.

## 3.2 Les fondamentaux du service SSH

> Le fichier de configuration du service SSH est /etc/ssh/sshd_config. Ce fichier est unique et n'a pas de ramification dans d'autres fichiers.

V√©rifions dans un premier temps la version du protocole SSH support√© avec la commande `ssh -v localhost` :

    [root@machine ssh]# ssh -v localhost
    OpenSSH_7.4p1, OpenSSL 1.0.2k-fips 26 Jan 2017
    debug1: Reading configuration data /etc/ssh/ssh_config
    ...
    debug1: Remote protocol version 2.0, remote software version OpenSSH_7.4
    ..
    ECDSA key fingerprint is SHA256:7H8DIiivqyhmlDIcOFc7jq3C4zna6CdPxrVH+ng5VSI.
    ECDSA key fingerprint is MD5:c5:86:1e:cd:ab:69:b9:a0:6a:bf:d2:89:6e:dd:31:9f.
    Are you sure you want to continue connecting (yes/no)?

Parmi les lignes affich√©es, on doit retrouver **Remote protocol version 2.0**. La version 2 am√®ne plus de fonctionnalit√©s et la version 1 du protocole est aujourd'hui obsol√®te.

> ‚ùå **RECOMMANDATION-CRITICAL** (D√©fense en profondeur) : V√©rifiez la version du protocole SSH support√© par le service exploit√© sur le serveur.

S'il y aune chose qu'il faut absolument bannir en ce qui concerne SSH, c'est la possibilit√© de se connecter directement avec le compte **root**. Ce r√©glage est indiqu√© dans le fichier de configuration avec la directive **PermitRootLogin** :

    [root@machine ~]# grep PermitRootLogin /etc/ssh/sshd_config
    #PermitRootLogin yes

Sur CentOS, par d√©faut, la directive poss√®de la valeur **yes** ce qui n'est pas le cas sur Debian.

Ici, il faudrait d√©commenter la ligne et indiquer **no** :

    PermitRootLogin no

Il faut noter qu'il est possible de positionner cette valeur sur **forced-commands-only**, ce qui laisse la possibilit√© au compte **root** de lancer une commande via le service en utilisant les cl√©s d'authentification. On revient dessus plus tard.

Enfin, dernier point fondamental : le port d'√©coute. Par d√©faut, SSH √©coute sur le port 22, il faudrait changer le port afin de compliquer le travail des attaquants.

    [root@machine ~]# grep Port /etc/ssh/sshd_config
    #Port 22

> ‚ùå **RECOMMANDATION-CRITICAL** (D√©fense en profondeur) : V√©rifiez le port d'√©coute du service SSH.

Par exemple, on pourrait indiquer ici :

    Port 6060

## 3.3 Le durcissement avanc√© du service SSH

Une fois les directives basiques pass√©es, il est temps de se pencher sur l'aspect un peu plus s√©curis√© de la configuration du service :
- pour emp√™cher des sessions connect√©es sans activit√© (idle), il faut utiliser les directives suivantes dans le fichier **/etc/ssh/sshd_config**.

Directives √† ajouter :

    ClientAliveInterval 300 # Timout idle max en seconde
    ClientAliveCountMax 0 # Nombre de messages de continuit√© autoris√©s sans r√©ponse du client

- pour emp√™cher toute connexion d'un compte utilisateur sans mot de passe, il faut positionner la directive suivante :

Directives √† modifier :

    PermitEmptyPasswords no

- pour autoriser une seule liste d'utilisateurs ou de groupes utilisateur √† se connecter, il faut positionner les directives suivantes :

Directives √† modifier :

    AllowGroups groupe1,groupe2,...
    AllowUsers user1,user2,...

- pour tracer les tentatives de connexion √©chou√©es en d√©tail, il faut positionner la directive suivante :

Directives √† modifier :

    MaxAuthTries 4 # Apr√®s 2 tentatives, les traces seront d√©taill√©es dans les fichiers de log

- dans le meilleur des cas, il est possible d'indiquer au service SSH de proc√©der √† l'authentification des comptes uniquement par √©change de cl√©s de cryptographie asym√©trique (**duo cl√© priv√©e/publique**). Ces cl√©s doivent √™tre g√©n√©r√©es de pr√©f√©rence avant le d√©ploiement du service. Elles permettent de s'authentifier sans avoir √† saisir de mot de passe, ce qui complique toute tentative d'espionnage de ces mots de passe. Les directives concern√©es sont :

Directives √† modifier :

    PasswordAuthentication no
    PubkeyAuthentication yes

> üö∏ **RECOMMANDATION-WARNING** (D√©fense en profondeur) : V√©rifiez le durcissement avanc√© du service SSH.

# 4. R√©sum√© des recommandations de toute cette partie

| Recommandation | Type | Principe |
| ----------- | ----------- | ----------- |
| Examiner la liste des _**sockets**_ **et ports ouverts** sur le r√©seau | ‚ùåCRITICAL | Minimisation |
| V√©rifier que les services qui ouvrent des **ports inutiles** sont d√©sactiv√©s | ‚ùåCRITICAL | Minimisation |
| V√©rifier que les services qui ouvrent des **ports** sur une interface **externe** sont pertinents | ‚ùåCRITICAL | D√©fense en profondeur |
| V√©rifier que les **ports par d√©faut** des services ont √©t√© chang√©s dans la mesure du possible | üö∏WARNING | D√©fense en profondeur |
| V√©rifier que les **TCP Wrappers** sont configur√©s pour les services r√©seau compatibles | ‚ùåCRITICAL | D√©fense en profondeur |
| V√©rifier qu'il est possible de rendre les services r√©seau **compatibles** avec les **TCP Wrappers** | üö∏WARNING | D√©fense en profondeur |
| V√©rifier qu'il est possible d'acc√©der **au firewall Netfilter** par le noyau sans la contrainte module | üö∏WARNING  | Minimisation |
| V√©rifier que les **r√®gles Netfilter** sont bien positionn√©es | ‚ùåCRITICAL | D√©fense en profondeur |
| V√©rifier que les **r√®gles Netfilter par d√©faut** sont d√©finies dans le fichier de configuration | ‚ùåCRITICAL | D√©fense en profondeur |
| V√©rifier le positionnement des sysctl r√©seau communes du noyau dans le fichier **/etc/sysctl.conf** | ‚ùåCRITICAL | D√©fense en profondeur |
| V√©rifier la **version du protocole SSH** support√© par le service exploit√© sur le serveur | ‚ùåCRITICAL | D√©fense en profondeur |
| Examiner la directive **PermitRootLogin** du service SSH | ‚ùåCRITICAL | Moindre privil√®ge |
| V√©rifier le **port d'√©coute du service SSH** | ‚ùåCRITICAL | D√©fense en profondeur |
| V√©rifier le **durcissement avanc√©** du service SSH | üö∏WARNING | D√©fense en profondeur |